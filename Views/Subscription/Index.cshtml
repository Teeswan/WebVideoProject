@model List<Youtube_Entertainment_Project.DTOs.SubscriptionDto>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    ViewData["Title"] = "My Subscribed Channels";
    var token = Antiforgery.GetAndStoreTokens(Context).RequestToken;
}

<div class="container mt-4">
    <h1><i class="bi bi-bell"></i> My Subscribed Channels</h1>
    <hr />

    @if (Model == null || Model.Count == 0)
    {
        <div class="alert alert-info">
            <p class="mb-0">You are not currently subscribed to any channels.</p>
        </div>
    }
    else
    {
        <table class="table table-striped table-hover" id="subscriptionTable">
            <thead>
                <tr>
                    <th>Channel Name</th>
                    <th>Subscribed At</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var sub in Model)
                {
                    <tr id="row-@sub.ChannelOwnerUserId">
                        <td><a href="/Channel/Details/@sub.ChannelOwnerUserId">@sub.ChannelName</a></td> 
                        <td>@sub.SubscribedAt.ToShortDateString()</td>
                        <td>
                            <button class="btn btn-sm btn-danger unsubscribe-btn" 
                                    data-channel-id="@sub.ChannelOwnerUserId"
                                    data-channel-name="@sub.ChannelName">
                                Unsubscribe
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>


@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = "@token";
            const table = document.getElementById('subscriptionTable');

            if (table) {
                table.addEventListener('click', async (event) => {
                    if (event.target.classList.contains('unsubscribe-btn')) {
                        event.preventDefault();

                        const button = event.target;
                        const channelId = button.dataset.channelId;
                        const channelName = button.dataset.channelName;
                        
                        if (!confirm(`Are you sure you want to unsubscribe from ${channelName}?`)) {
                            return;
                        }

                        button.disabled = true;
                        button.textContent = 'Unsubscribing...';

                        try {
                            const formData = new FormData();
                            formData.append('channelId', channelId);
                            formData.append('__RequestVerificationToken', token);

                            const response = await fetch('/api/Subscription/Toggle', {
                                method: 'POST',
                                body: formData 
                            });

                            if (response.ok) {
                                
                                const rowToRemove = document.getElementById(`row-${channelId}`);
                                if (rowToRemove) {
                                    rowToRemove.remove();
                                }

                                if (table.tBodies[0].rows.length === 0) {
                                    const container = document.querySelector('.container');
                                    container.innerHTML = `
                                        <h1><i class="bi bi-bell"></i> My Subscribed Channels</h1>
                                        <hr />
                                        <div class="alert alert-info">
                                            <p class="mb-0">You are not currently subscribed to any channels.</p>
                                        </div>
                                    `;
                                }

                                console.log(`Successfully unsubscribed from ${channelName}`);
                            } else {
                                // Handle API errors
                                const errorData = await response.json().catch(() => ({ error: 'Unknown API Error' }));
                                alert(`Failed to unsubscribe from ${channelName}: ${errorData.error || 'Server error.'}`);
                            }

                        } catch (error) {
                            console.error("Network or processing error:", error);
                            alert(`A network error occurred while unsubscribing from ${channelName}.`);
                        } finally {
                            if (button.closest('tr')) { 
                                button.disabled = false;
                                button.textContent = 'Unsubscribe';
                            }
                        }
                    }
                });
            }
        });
    </script>
}