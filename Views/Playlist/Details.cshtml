@model Youtube_Entertainment_Project.DTOs.PlaylistDto
@using Microsoft.AspNetCore.Identity
@using Youtube_Entertainment_Project.Data.Entity
@inject UserManager<AppUser> UserManager
@inject SignInManager<AppUser> SignInManager

@{
    ViewData["Title"] = "Playlist: " + Model.Title;
    bool canManage = false;
    // ... (keep your existing Identity logic) ...

    var firstVideo = Model.Videos?.OrderBy(x => x.Position).FirstOrDefault();
    var coverThumbnail = "/images/default-thumbnail.jpg";

    if (firstVideo != null && !string.IsNullOrEmpty(firstVideo.ThumbnailUrl))
    {
        coverThumbnail = firstVideo.ThumbnailUrl;
        // Fix: Add leading slash if missing
        if (!coverThumbnail.StartsWith("/") && !coverThumbnail.StartsWith("http"))
        {
            coverThumbnail = "/" + coverThumbnail;
        }
    }
}

<div class="container mt-5">
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden position-sticky" style="top: 20px;">
                <div class="position-relative">
                    <img src="@coverThumbnail" class="w-100" style="height: 220px; object-fit: cover; filter: brightness(0.7);" alt="Cover" />
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <i class="bi bi-play-btn-fill text-white display-1 opacity-75"></i>
                    </div>
                </div>

                <div class="card-body">
                    <h2 class="fw-bold h4">@Model.Title</h2>
                    <p class="text-muted mb-1 small">
                        <i class="bi @(Model.IsPublic ? "bi-globe text-success" : "bi-lock-fill text-danger")"></i>
                        @(Model.IsPublic ? "Public Playlist" : "Private Playlist")
                    </p>
                    <p class="small text-secondary">@((Model.Videos?.Count) ?? 0) Videos</p>

                    <div class="mt-3 d-grid gap-2">
                        @if (Model.Videos != null && Model.Videos.Any())
                        {
                            var firstVideoId = Model.Videos.OrderBy(x => x.Position).First().VideoId;
                            <a asp-controller="Video" asp-action="Details" asp-route-id="@firstVideoId" class="btn btn-primary rounded-pill">
                                <i class="bi bi-play-fill"></i> Play All
                            </a>
                        }

                        @if (canManage)
                        {
                            <a asp-action="Edit" asp-route-id="@Model.PlaylistId" class="btn btn-outline-secondary btn-sm rounded-pill">
                                <i class="bi bi-pencil"></i> Edit Details
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Videos</h4>
            </div>

            @if (Model.Videos != null && Model.Videos.Any())
            {
                <div class="list-group list-group-flush shadow-sm rounded-4 overflow-hidden border">
                    @foreach (var v in Model.Videos.OrderBy(x => x.Position))
                    {
                        string currentThumb = "/images/default-thumbnail.jpg";

                        if (!string.IsNullOrEmpty(v.ThumbnailUrl))
                        {
                            currentThumb = v.ThumbnailUrl;
                            if (!currentThumb.StartsWith("/") && !currentThumb.StartsWith("http"))
                            {
                                currentThumb = "/" + currentThumb;
                            }
                        }

                        <div class="list-group-item list-group-item-action d-flex align-items-center p-2 border-bottom">
                            <span class="mx-2 fw-bold text-muted small" style="width: 20px;">@v.Position</span>

                            <div class="me-3 position-relative" style="width: 140px; height: 80px; flex-shrink: 0;">
                                <img src="@currentThumb"
                                     class="rounded w-100 h-100"
                                     style="object-fit: cover;"
                                     alt="Thumbnail" />
                            </div>

                            <div class="flex-grow-1 overflow-hidden">
                                <h6 class="mb-0 fw-bold text-truncate">
                                    <a asp-controller="Video" asp-action="Details" asp-route-id="@v.VideoId" class="text-decoration-none text-dark">
                                        @v.VideoTitle
                                    </a>
                                </h6>
                                <small class="text-muted d-block">Added to playlist</small>
                            </div>

                            <div class="ms-auto pe-2">
                                <a asp-controller="Video" asp-action="Details" asp-route-id="@v.VideoId" class="btn btn-light btn-sm rounded-circle shadow-sm">
                                    <i class="bi bi-play-fill fs-5"></i>
                                </a>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-light border text-center p-5 rounded-4 shadow-sm">
                    <i class="bi bi-collection-play display-4 text-muted"></i>
                    <p class="mt-3 fs-5">This playlist is empty.</p>
                    <a asp-controller="Video" asp-action="Index" class="btn btn-primary rounded-pill">Find Videos to Add</a>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .list-group-item:hover {
        background-color: #f8f9fa;
    }

    .text-truncate {
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>