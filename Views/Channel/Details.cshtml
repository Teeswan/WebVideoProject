@model Youtube_Entertainment_Project.DTOs.ChannelDto
@using Microsoft.AspNetCore.Identity
@using Youtube_Entertainment_Project.Data.Entity
@inject UserManager<AppUser> UserManager
@inject SignInManager<AppUser> SignInManager

@{
    ViewData["Title"] = Model.Name;

    bool isOwner = false;
    bool isSuperAdmin = false;
    bool isSubscribed = ViewBag.IsSubscribed ?? false;

    if (SignInManager.IsSignedIn(User))
    {
        var currentUser = await UserManager.GetUserAsync(User);
        if (currentUser != null)
        {
            isOwner = currentUser.Id == Model.OwnerUserId;
            isSuperAdmin = await UserManager.IsInRoleAsync(currentUser, "SuperAdmin");

            isSubscribed = Model.Subscribers != null && Model.Subscribers.Any(s => s.SubscriberUserId == currentUser.Id);
        }
    }
}

<style>
    /* Profile Section Styling */
    .channel-header {
        margin-top: 2rem;
        margin-bottom: 2rem;
    }

    .profile-img {
        width: 160px;
        height: 160px;
        object-fit: cover;
        border: 4px solid #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* Video Grid Styling */
    .video-card img {
        aspect-ratio: 16/9;
        object-fit: cover;
        border-radius: 12px;
        transition: transform 0.2s ease;
    }

    .video-card:hover img {
        transform: scale(1.02);
    }

    /* Play Overlay */
    .video-thumbnail-container {
        position: relative;
        display: block;
        overflow: hidden;
        border-radius: 12px;
    }

    .play-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .video-thumbnail-container:hover .play-overlay {
        opacity: 1;
    }

    .play-overlay i {
        color: white;
        font-size: 3rem;
    }

    #subscriberCount {
        transition: all 0.3s ease;
    }
</style>

<div class="container">
    <div class="row channel-header align-items-center">
        <div class="col-md-auto text-center mb-3 mb-md-0">
            @{
                var profilePic = string.IsNullOrEmpty(Model.OwnerProfileImagePath)
                ? "/images/default-profile.png"
                : Model.OwnerProfileImagePath;
                if (!profilePic.StartsWith("/") && !profilePic.StartsWith("http")) profilePic = "/" + profilePic;
            }
            <img src="@profilePic" class="rounded-circle profile-img" alt="@Model.Name">
        </div>
        <div class="col-md">
            <h1 class="fw-bold mb-1">@Model.Name</h1>
            <p class="text-muted mb-2">
                @@@Model.Name.Replace(" ", "").ToLower() •
                <span id="subscriberCount">@(ViewBag.SubscriberCount ?? 0)</span> subscribers •
                @(Model.Videos?.Count ?? 0) videos
            </p>
            <p class="text-secondary mb-3">@Model.Description</p>

            <div class="d-flex gap-2">
                @if (isOwner || isSuperAdmin)
                {
                    <a asp-controller="Video" asp-action="Create" class="btn btn-primary rounded-pill px-4">
                        <i class="bi bi-cloud-upload-fill"></i> Upload Video
                    </a>

                    <a asp-action="Edit" asp-route-id="@Model.ChannelId" class="btn btn-outline-dark rounded-pill px-4">
                        <i class="bi bi-pencil"></i> Customize Channel
                    </a>
                    <a asp-action="Delete" asp-route-id="@Model.ChannelId" class="btn btn-outline-danger rounded-pill px-4">
                        <i class="bi bi-trash"></i> Delete
                    </a>
                }
                else
                {
                   
                    <button id="subBtn"
                            data-id="@Model.OwnerUserId"
                            class="btn @(isSubscribed ? "btn-dark" : "btn-secondary") rounded-pill px-4 fw-bold">
                        @(isSubscribed ? "Subscribe" : "Subscribed")
                    </button>

                    // <div class="col-12 text-center py-5">
                    //     <i class="bi bi-play-btn display-1 text-light-emphasis"></i>
                    //     <p class="mt-3 text-muted">This channel has no videos yet.</p>

                    //     @if (isOwner)
                    //     {
                    //         <div class="mt-3">
                    //             <p class="fw-bold">Ready to share your first story?</p>
                    //             <a asp-controller="Video" asp-action="Upload" class="btn btn-primary rounded-pill px-4">
                    //                 Get Started
                    //             </a>
                    //         </div>
                    //     }
                    // </div>

                }
            </div>
        </div>
    </div>

    <hr class="my-4">

    @* --- Navigation Tabs --- *@
    <ul class="nav nav-underline mb-4">
        <li class="nav-item"><a class="nav-link active text-dark fw-bold" href="#">Home</a></li>
        <li class="nav-item"><a class="nav-link text-muted" href="#">Videos</a></li>
        <li class="nav-item"><a class="nav-link text-muted" href="#">Playlists</a></li>
    </ul>

    @* --- Video Grid Section --- *@
    <div class="row g-4">
        @if (Model.Videos != null && Model.Videos.Any())
        {
            @foreach (var video in Model.Videos)
            {
                <div class="col-12 col-sm-6 col-lg-3">
                    <div class="video-card">
                        <a asp-controller="Video" asp-action="Details" asp-route-id="@video.VideoId" class="text-decoration-none">
                            <div class="video-thumbnail-container shadow-sm">
                                <img src="@(string.IsNullOrEmpty(video.ThumbnailUrl) ? "/images/default-thumbnail.jpg" : video.ThumbnailUrl)"
                                     class="img-fluid" alt="@video.Title">
                                <div class="play-overlay"><i class="bi bi-play-fill"></i></div>
                            </div>
                            <div class="mt-2">
                                <h6 class="text-dark fw-bold mb-1 text-truncate">@video.Title</h6>
                                <p class="text-muted extra-small mb-0">@video.ViewCount views • @(video.CreatedAt.ToShortDateString())</p>
                            </div>
                        </a>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center py-5">
                <i class="bi bi-play-btn display-1 text-light-emphasis"></i>
                <p class="mt-3 text-muted">This channel has no videos yet.</p>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $("#subBtn").click(function () {
                const btn = $(this);
                const channelId = btn.attr("data-id");

                const formData = new FormData();
                formData.append("channelId", channelId);

                $.ajax({
                    url: "/api/Subscription/Toggle",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.isSubscribed) {
                            btn.text("Subscribed").removeClass("btn-dark").addClass("btn-secondary");
                        } else {
                            btn.text("Subscribe").removeClass("btn-secondary").addClass("btn-dark");
                        }

                        $("#subscriberCount").text(response.subscriberCount);
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            window.location.href = "/Identity/Account/Login";
                        } else {
                            console.error("Subscription error", xhr.responseText);
                        }
                    }
                });
            });
        });
    </script>
}